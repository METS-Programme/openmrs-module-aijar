<!--<?xml version="1.0" encoding="utf-8"?>-->
<htmlform formName="Form 096a - Health Unit TB Register - Follow up"
          formDescription="HMIS Form 096a - Health Unit TB Register - Follow up"
          formEncounterType="334bf97e-28e2-4a27-8727-a5ce31c7cd66"
          formUuid="b609b3f0-6fa8-4764-976e-625f0683b690"
          formVersion="1.0"
          formAddMetadata="yes"
          formUILocation="patientDashboard.visitActions"
          formOrder="2"
          formIcon="icon-medkit"
          formShowIf="(visit.active || !visit.active) &amp;&amp; patient.person.dead==false &amp;&amp; sessionLocation.uuid=='8ab22b55-9a17-4121-bf08-6134a9a2439f'"
          formDisplayStyle="Standard"
          formLabel="Form 096a - Health Unit TB Register - Summary">
    <ifMode mode="ENTER,EDIT">
        <includeIf velocityTest="$fn.allEncounters('334bf97e-28e2-4a27-8727-a5ce31c7cd66').size() == 0">
            <script>
                jq(function () {
                    alert('This patient has no Summary page, you will now be forwarded to the patient dashboard');

                    /*
                     * queryParameters -> handles the query string parameters
                     * queryString -> the query string without the fist '?' character
                     * re -> the regular expression
                     * m -> holds the string matching the regular expression
                     */
                    var queryParameters = {}, queryString = location.search.substring(1),
                            re = /([^&amp;=]+)=([^&amp;]*)/g, m;

                    // Creates a map with the query string parameters
                    while (m = re.exec(queryString)) {
                        queryParameters[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
                    }

                    /*
                     * Replace the query portion of the URL.
                     * jQuery.param() -> create a serialized representation of an array or
                     *     object, suitable for use in a URL query string or Ajax request.
                     */
                    location.href = window.location.protocol + "//" + window.location.host +
                            '/' + OPENMRS_CONTEXT_PATH + '/coreapps/clinicianfacing/patient.page?patientId='
                            + queryParameters['patientId']; // Causes page to reload
                });
            </script>
        </includeIf>
    </ifMode>

	<style type="text/css">
	    table#drugs tbody td {
	        width: 25;
	        border: 1px solid rgb(199, 199, 199) !important;
	    }

	    table#drugs td.no-of-days-to-take-drugs input {
	        min-width: 20%;
	        width: 25px !important;
	    }

	    table#drugs td.no-of-days-to-take-drugs select {
	        min-width: 20%;
	        width: 50% !important;
	        clear: none !important;
	    }

	    .inError {
	        border: 2px dotted #ff0000 !important;
	    }
	</style>

	<script type="text/javascript">
	    /*
	    Transfer in Unit-TB Number	Only applicable if Transfer In - done -
	    CPT Start Date	Required/Enabled if patient is on CPT -done
	    ART Start Date	Required/Enabled if patient is on ART -done -
	    ART Number	Required/Enabled if patient is on ART -done-
	    No of children in contact	should always be greater than no of children on IPT -done-
	    INR No.	should only be enabled/Reqired if MUAC Colour Code is red or yellow -done
	    Transfer out to	Required/Enabled if treatment outcome is 'transfer out' -done -
	    MUAC/z-score section	applicable for clients aged 6months and above and below 15 years -done -
	    */

	    if (jQuery) {
	        jq(document).ready(function () {
	            if (jq.browser.msie) {
	                jq(":checkbox").click(function () {
	                    jq(this).change();
	                });
	            }
	        });
	    }

	    jQuery().ready(function(jq){
	        var $muacColorCodeField,
				$inrNumberField;

	        $muacColorCodeField = jq('#muac-color-code').find('input');
	        $inrNumberField = jq('#inr-number').find('input');

	        var muacColorCodeChange = function() {
	            var muacColorCodeValue = getValue('muac-color-code.value');
	            if (muacColorCodeValue == YELLOW_CONCEPT_ID || muacColorCodeValue == RED_CONCEPT_ID) {
	                fieldHelper.enable($inrNumberField);
	            } else {
	                fieldHelper.disable($inrNumberField);
	            }
	        };

	        /**
	        * Validation for the TB Drugs section
	        * This validation check works this way:
	        * For each visible row, If any text box or combo box is non-empty, check if there's any other text box or combobox within the same row that is empty.
	        * If so, validation fails and the elements with missing values are highlighted
	        */
	        var drugsValidated = function () {
	            var $rows,
	                $objectsToValidate;
	            var dirty = false;

	            $rows = jq('table#drugs&gt;tbody tr:visible');
	            $rows.each(function () {
	                $objectsToValidate = jq(this).find('input,select'); //Get all text and combo boxes
	                $objectsToValidate.removeClass('inError');
	                $objectsToValidate.each(function () {
	                    $obj = jq(this);
	                    if ($obj.val() !== '') { //Only run the validatiion check if there's at least one element that is non-empty
	                        $objectsToValidate.each(function () {
	                            if (jq(this).val() === '') {
	                                jq(this).addClass('inError');
	                                jq(this).siblings('span.error').html('Required').show()
	                                dirty = true;
	                            } else {
	                                jq(this).siblings('span.error').html('').hide();
	                            }
	                        });
	                    }
	                });
	            });

	            return !dirty;
	        }

	        $muacColorCodeField.change(muacColorCodeChange());

	        muacColorCodeChange();

	        beforeSubmit.push(function(){
	            var valid = true;

	            if (!drugsValidated()) {
	                valid = false;
	            }

	            return valid;
	        });

	    });

	    jQuery(document).ready(function(jq) {
	        //Adding new form
	        var $allRows,
	            $otherRows,
	            $firstRow,
	            $thisRow,
	            $nextRow,
	            $hiddenRows,
	            $lastVisibleRow,
	            $nonEmptyBoxes;

	        var showAddButtonForLastVisibleRow = function() {
	            $lastVisibleRow = $('table#drugs &gt; tbody &gt; tr:visible:last');
	            $lastVisibleRow.find('.add').show();
	        };

	        $allRows = jq('table#drugs &gt; tbody &gt; tr');
	        $firstRow = jq('table#drugs tbody tr:first-of-type');
	        $otherRows = jq('table#drugs tbody tr:not(:first-of-type)');

	        <ifMode mode="ENTER">
	            $otherRows.hide(); //Hide all rows apart from first row if adding new form
	        $firstRow.find('.remove').hide(); //Hide the remove button from the first row
	        </ifMode>

	        <ifMode mode="EDIT">
	            //Handle loading of existing obs
	            $allRows.hide();
	        $nonEmptyBoxes = jq('input').filter(function() {
	            return this.value.length &gt; 0;
	        });

	        if ($nonEmptyBoxes.length &gt; 0 ) {
	            $nonEmptyBoxes.each(function() {
	                $thisRow = jq(this).parents('tr:first');
	                $thisRow.show();
	            });

	            if ($nonEmptyBoxes.length == 1) {
	                $nonEmptyBoxes.parents('tr:first').find('.remove').hide(); //Hide the remove button if there is only one visible row
	            }

	        } else {
	              $firstRow.show();
	        $firstRow.find('.remove').hide();
	    }
	        </ifMode>

	        jq('.add').click(function(e) { //Handle add button event
	            e.preventDefault();
	            $thisRow = jq(this).parents('tr:first');
	            $nextRow = $thisRow.next();

	            if ($nextRow.length &gt; 0) {
	                $nextRow.show();
	                $thisRow.find('.add').hide();
	            }
	            showAddButtonForLastVisibleRow();
	        });

	    jq('.remove').click(function(e) { //Handle remove button event
	        e.preventDefault();
	        $thisRow = jq(this).parents('tr:first');
	        $thisRow.hide();
	        showAddButtonForLastVisibleRow();
	    });
	    });
	</script>

  <div class="ai-page-frame">
    <div class="headers" style="text-align: center;">
      <h3 style="background: #FFFF7D; padding: 10px;">096a - Health Unit TB Register - Follow up Page</h3>
    </div>
    <section>
      <fieldset>
        <legend>Encounter details</legend>
        <table>
          <tbody>
            <tr>
              <td>
                <p>
                  <label>
                    <span class="required">*</span>Follow up visit date:
                  </label>
                  <encounterDate default="today" disallowMultipleEncountersOnDate="block"/>
                </p>
              </td>
              <td>
                <span style="display: none;">
                  <encounterLocation default="8ab22b55-9a17-4121-bf08-6134a9a2439f"
                                     order="8ab22b55-9a17-4121-bf08-6134a9a2439f"/>
                </span>
              </td>
              <td>
                <label>
                  <span class="required">*</span> Provider:
                </label>
                <encounterProvider role="Provider" style="autocomplete" required="required"/>
              </td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </fieldset>
    </section>
    <fieldset>
      <legend>Results of sputum and other examinations</legend>
      <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td>
            <p>
              <label>Sputum smear results</label>
              <obs conceptId="307" answerConceptIds="1118,664,1362,1363,1364,1365,163417AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,163418AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,164428,164429,164430,159985,703,160008" answerLabels="ND - Not Done, NEG- Negative, 1AFB/100, 2AFB/100, 3AFB/100, 4AFB/100,5AFB/100,6AFB/100,7AFB/100,8AFB/100,9AFB/100,Scanty,Positive,contaminated specimen" style="dropdown"/>
            </p>
          </td>
          <td >
            <p>
              <label>Examination Date</label>
              <obs conceptId="99392" />
            </p>
          </td>
          <td >
            <p>
              <label>DST Results</label>
              <obs conceptId="159984AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="164366,164432,159345,664,164367,159346" answerLabels="Rif Monoresistant,INH Monoresistant,MDR Confirmed,Polyresistant,Pan Sensitive,XDR Confirmed" style="dropdown"/>
            </p>
          </td>
          <td >
            <p>
              <label>Date of DST results</label>
              <obs conceptId="164396" />
            </p>
          </td>
        </tr>
      </table>
    </fieldset>
    <fieldset>
      <legend>MUAC/z-score</legend>
      <table width="100%" border="0" cellspacing="0" cellpadding="0" id="muac">
        <tr>
          <td colspan="2" valign="top" >
            <p>
              <label>Weight for age z-score</label>
              <obs conceptId="1854AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="115,99271,99272" answerLabels="N-Normal,MAM-Moderate Acute Mulnutrition,SAM-Severe Acute Mulnutrition" style="dropdown" answerSeparator="&lt;br/&gt;" />
            </p>
          </td>
          <td colspan="2" valign="top" >
            <p>
              <label>Height/Length for age z-score</label>
              <obs conceptId="164088" answerConceptIds="1115,164085" answerLabels="N-Normal,S-Stunting" />
            </p>
          </td>
          <td valign="top">
            <p>
              <label>MUAC Colour Code</label>
              <obs conceptId="99030" answerConceptIds="99028,99027,99029" answerLabels="Red,Green,Yellow" id="muac-color-code" style="radio"/>
            </p>
          </td>
          <td valign="top" >
            <p>
              <label>INR No</label>
              <span id="inr-number">
                <patient  field="identifier" identifierTypeId="d4b21726-e908-4b1a-abab-b5f87cd01c18" id="inr-no" required="true" />
              </span>
            </p>
          </td>
        </tr>
      </table>
    </fieldset>
    <fieldset>
      <legend>Issue of anti-TB drug</legend>
      <table width="100%" border="0" cellspacing="0" cellpadding="0" style="width:100%" id="drugs">
        <thead>
          <tr>
            <th >  TB Treatment phase    </th>
            <th >
              <p>
                <label>Name of drug</label>
              </p>
            </th>
            <th >
              <p>
                <label>No. of days for which Treatment is dispensed</label>
              </p>
            </th>
            <th align="center"></th>
          </tr>
        </thead>
        <tbody>
          <repeat>
            <template>
              <obsgroup groupingConceptId="163711">
                <tr>
                  <td >
                    <p>
                      <obs conceptId="159792" answerConceptIds="159794,159795" answerLabels="Initial, Retreatment" style="radio"/>
                    </p>
                  </td>
                  <td>
                    <p>
                      <obs conceptId="1282" answerConceptSetIds="160021" style="dropdown" />
                    </p>
                  </td>
                  <td class="no-of-days-to-take-drugs">
                    <p>
                      <obs conceptId="159368" />
                      <obs conceptId="1732" />
                    </p>
                  </td>
                  <td align="center">
                    <a href="#" class="add">Add</a> | <a href="#" class="remove">Remove</a>
                  </td>
                </tr>
              </obsgroup>
            </template>
            <render />
            <render />
            <render />
            <render />
            <render />
            <render />
            <render />
            <render />
            <render />
            <render />
          </repeat>
        </tbody>
      </table>
    </fieldset>
    <submit/>
  </div>
</htmlform>